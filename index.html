<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Windborne Flight Constellation — Challenge</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      background: rgba(255,255,255,.95); padding: 12px 14px; border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.12); font: 14px/1.35 system-ui, Arial, sans-serif; max-width: 360px;
    }
    .panel h1 { margin: 0 0 6px; font-size: 16px; }
    .panel button { cursor: pointer; border: 0; padding: 8px 10px; border-radius: 8px;
      background: #111; color: #fff; font-weight: 600; }
    .legend { font-size: 12px; opacity: .9; margin-top: 8px; }
    .error { color: #b00020; font-weight: 600; }
    .foot {
      position: absolute; right: 12px; bottom: 12px; z-index: 1000;
      background: rgba(255,255,255,.9); padding: 6px 8px; border-radius: 8px; font: 12px system-ui, Arial;
    }
    a { color: #0056cc; text-decoration: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h1>Windborne Balloon Constellation</h1>
    <div id="status">Loading latest 24h…</div>
    <div class="legend">
      • Circles = current balloon positions (click for weather)<br>
      • Faint dots = prior hours (most recent is darkest)<br>
      • Auto-refresh every 5 min
    </div>
    <div style="margin-top:8px">
      <button id="refreshBtn">Refresh now</button>
    </div>
  </div>

  <div class="foot">
    Built for the Flight Team Web Developer challenge — Combined with Open-Meteo current weather.
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script>
    // -------- CONFIG --------
    // Use a public proxy to bypass CORS for the Windborne treasure endpoint
    const PROXY = "https://corsproxy.io/?";
    const TREASURE_HOST = "https://a.windbornesystems.com/treasure";
    const HOURS = 24;                    // 00..23
    const REFRESH_MS = 5 * 60 * 1000;    // 5 minutes

    // Map
    const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 8,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const layers = {
      current: L.layerGroup().addTo(map),
      history: L.layerGroup().addTo(map) // contains sublayers per hour
    };

    const statusEl = document.getElementById('status');
    document.getElementById('refreshBtn').addEventListener('click', () => bootstrap(true));

    // ---------- Helpers ----------
    const isNum = (n) => typeof n === "number" && isFinite(n);
    function clampLatLon(lat, lon) {
      if (!isNum(lat) || !isNum(lon)) return null;
      if (lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
      return [lat, lon];
    }

    // Normalizer that supports the array format you saw: [lat, lon, alt]
    function normalizeRecord(rec) {
      if (Array.isArray(rec)) {
        const [lat, lon, alt] = rec;
        const ok = clampLatLon(Number(lat), Number(lon));
        if (!ok) return null;
        return { id: "balloon", lat: ok[0], lon: ok[1], alt: isNum(Number(alt)) ? Number(alt) : null, time: null };
      }
      // Fallback in case some hours use objects
      const lat = rec?.lat ?? rec?.latitude ?? rec?.Lat ?? rec?.Latitude;
      const lon = rec?.lon ?? rec?.lng ?? rec?.longitude ?? rec?.Lon ?? rec?.Lng ?? rec?.Longitude;
      const alt = rec?.alt ?? rec?.altitude ?? rec?.Altitude;
      const id  = rec?.id ?? rec?.name ?? rec?.serial ?? rec?.balloon_id ?? rec?.balloon ?? rec?.call ?? rec?.callsign ?? "balloon";
      const t   = rec?.time ?? rec?.timestamp ?? rec?.t ?? rec?.date ?? rec?.ts ?? null;
      const ok = clampLatLon(Number(lat), Number(lon));
      if (!ok) return null;
      return { id, lat: ok[0], lon: ok[1], alt: isNum(Number(alt)) ? Number(alt) : null, time: t };
    }

    function normalizePayload(json) {
      // Accept array-of-arrays, array-of-objects, object with {records: [...]}, or object map
      if (Array.isArray(json)) return json.map(normalizeRecord).filter(Boolean);
      if (Array.isArray(json?.records)) return json.records.map(normalizeRecord).filter(Boolean);
      if (json && typeof json === "object") return Object.values(json).map(normalizeRecord).filter(Boolean);
      return [];
    }

    // Build proxied URL (with cache-buster)
    function treasureUrl(hh) {
      return `${PROXY}${TREASURE_HOST}/${hh}.json?t=${Date.now()}`;
    }

    async function fetchHour(hour) {
      const hh = String(hour).padStart(2,'0');
      const url = treasureUrl(hh);
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`Fetch ${hh}.json failed: ${res.status}`);
        const json = await res.json();
        return normalizePayload(json);
      } catch (e) {
        console.error('Treasure fetch error', hh, e);
        return [];
      }
    }

    // Weather: Open-Meteo current weather (no API key)
    async function fetchWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) return null;
        const j = await res.json();
        return j.current_weather || null;
      } catch {
        return null;
      }
    }

    function colorForHourIndex(h) {
      // 0 .. 23 where 0 = most recent past hour, darker for recent, lighter for older
      const light = 30 + Math.round((h / (HOURS-1)) * 55); // 30..85%
      return `hsl(210, 80%, ${light}%)`;
    }

    function draw(perHour) {
      layers.current.clearLayers();
      layers.history.clearLayers();

      const bounds = [];

      // Latest hour (00.json) -> interactive markers with weather
      const latest = perHour[perHour.length - 1] || [];
      for (const p of latest) {
        const marker = L.circleMarker([p.lat, p.lon], {
          radius: 6, weight: 2, color: "#111", fillOpacity: 0.9, fillColor: "#2a7"
        }).addTo(layers.current);

        (async () => {
          const wx = await fetchWeather(p.lat, p.lon);
          const wxHtml = wx
            ? `<div><b>Weather</b>: ${wx.temperature}&deg;C, wind ${wx.windspeed} m/s @ ${wx.winddirection}&deg;</div>`
            : `<div><i>Weather unavailable</i></div>`;
          const altHtml = isNum(p.alt) ? `<div>Alt: ${p.alt}</div>` : "";
          marker.bindPopup(`<b>Balloon</b><br>${altHtml}${wxHtml}`);
        })();

        bounds.push([p.lat, p.lon]);
      }

      // Prior hours -> faint dots, hour shading
      for (let i = 0; i < perHour.length - 1; i++) {
        const hourLayer = L.layerGroup().addTo(layers.history);
        const pts = perHour[i];
        const color = colorForHourIndex(perHour.length - 2 - i); // 0=most recent past
        for (const p of pts) {
          L.circleMarker([p.lat, p.lon], {
            radius: 3, weight: 1, color, fillOpacity: 0.5, fillColor: color
          }).addTo(hourLayer);
        }
      }

      if (bounds.length) map.fitBounds(bounds, { padding: [30,30] });
    }

    async function bootstrap(manual = false) {
      statusEl.textContent = manual ? "Refreshing…" : "Loading latest 24h…";
      try {
        // fetch 23..00 so we can easily pick "latest"
        const hours = Array.from({length: HOURS}, (_,i)=>HOURS-1-i);
        const results = await Promise.allSettled(hours.map(fetchHour));
        const perHour = results.map(r => r.status === "fulfilled" ? r.value : []);

        draw(perHour);
        const latestCount = perHour[perHour.length - 1]?.length ?? 0;
        statusEl.textContent = `Loaded ${latestCount} current balloons · history: ${HOURS-1} hours`;
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="error">Load failed.</span> See console for details.`;
      }
    }

    bootstrap();
    setInterval(bootstrap, REFRESH_MS);
  </script>
</body>
</html>
